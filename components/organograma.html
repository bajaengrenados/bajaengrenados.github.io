<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Organograma</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS do site -->
  <link rel="stylesheet" href="/assets/css/institucional.css">
</head>

<body>

  <!-- Organograma -->
  <div class="organograma" id="organograma"></div>


  <script>

    /* ===============================
       BUSCA OS MEMBROS DA INDEX
       =============================== */

    async function carregarMembros() {

      const response = await fetch('/index.html');
      const html = await response.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      return doc.querySelectorAll('.member');
    }


    /* ===============================
       MONTA ORGANOGRAMA
       =============================== */

    async function montarOrganograma() {

      const members = await carregarMembros();


      const estrutura = {
        coordenador: null,
        capitao: null,
        tesoureiro: null,
        setores: {}
      };


      const mapaSetores = {
        'Projetos': 'Projetos',
        'Relações Publicas': 'Relações Públicas',
        'Marketing': 'Marketing',
        'Chassis e Freio': 'Chassis e Freio',
        'Motor e Transmissão': 'Motor e Transmissão',
        'Suspensão e Direção': 'Suspensão e Direção',
        'Eletrica': 'Elétrica',
        'Elétrica': 'Elétrica',
        'TI': 'TI'
      };


      // Inicializa setores
      Object.values(mapaSetores).forEach(setor => {
        estrutura.setores[setor] = { sup: null, aux: [] };
      });


      // Lê membros
      members.forEach(member => {

        const nome = member.querySelector('h4')?.textContent.trim();
        const cargo = member.querySelector('h5')?.textContent.trim();

        if (!nome || !cargo) return;


        if (cargo.includes('Coordenador')) {
          estrutura.coordenador = nome;
          return;
        }

        if (cargo.includes('Capitão')) {
          estrutura.capitao = nome;
          return;
        }

        if (cargo.includes('Tesoureiro')) {
          estrutura.tesoureiro = nome;
          return;
        }


        if (cargo.includes('Sup.')) {

          Object.keys(mapaSetores).forEach(key => {

            if (cargo.includes(key)) {
              estrutura.setores[mapaSetores[key]].sup = nome;
            }

          });

          return;
        }


        if (cargo.includes('Aux.')) {

          Object.keys(mapaSetores).forEach(key => {

            if (cargo.includes(key)) {
              estrutura.setores[mapaSetores[key]].aux.push(nome);
            }

          });

        }

      });


      // Ordena auxiliares
      Object.values(estrutura.setores).forEach(setor => {
        setor.aux.sort((a, b) => a.localeCompare(b, 'pt-BR'));
      });



      /* ===============================
         RENDER
         =============================== */

      const org = document.getElementById('organograma');
      org.innerHTML = '';


      function criarNivel(html) {

        const div = document.createElement('div');
        div.className = 'org-nivel';
        div.innerHTML = html;

        org.appendChild(div);
      }


      function criarLinha() {

        const linha = document.createElement('div');
        linha.className = 'org-linha';

        org.appendChild(linha);
      }


      // Coordenador
      criarNivel(`
        <div class="org-box">
          ${estrutura.coordenador || 'A definir'}<br>
          <small>Coordenador</small>
        </div>
      `);

      criarLinha();


      // Capitão
      criarNivel(`
        <div class="org-box">
          ${estrutura.capitao || 'A definir'}<br>
          <small>Capitão</small>
        </div>
      `);

      criarLinha();


      // Tesoureiro
      criarNivel(`
        <div class="org-box">
          ${estrutura.tesoureiro || 'A definir'}<br>
          <small>Tesoureiro</small>
        </div>
      `);

      criarLinha();


      // Setores
      const setoresDiv = document.createElement('div');
      setoresDiv.className = 'org-nivel org-setores';


      Object.entries(estrutura.setores).forEach(([nome, setor]) => {

        let html = `<strong>${nome}</strong><br><br>`;

        if (setor.sup) html += `${setor.sup} (Sup.)<br>`;

        setor.aux.forEach(aux => {
          html += `${aux} (Aux.)<br>`;
        });


        const box = document.createElement('div');
        box.className = 'org-box setor';
        box.innerHTML = html;

        setoresDiv.appendChild(box);

      });


      org.appendChild(setoresDiv);

    }


    // Start
    montarOrganograma();

  </script>


</body>
</html>